<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administrador - ARIBRA</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --navy:#17384A;
      --navy-2:#123040;
      --bg:#ffffff;
      --cyan-1:#79E6EC; /* claro */
      --cyan-2:#58C6D8; /* medio */
      --cyan-3:#1F86A5; /* escuro */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      font-family:'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;
      color:#0b1a23;
      overflow:hidden;
    }

    .wrap{ position:relative; height:100vh; width:100vw; display:flex; }

    /* Sidebar colapsável + hambúrguer */
    .sidebar{ position:fixed; left:0; top:0; bottom:0; width:220px; background:#fff; border-right:3px solid var(--navy); padding:28px 14px; display:flex; flex-direction:column; align-items:center; gap:18px; z-index:1001; transform:translateX(-100%); transition:transform .25s ease; }
    body.nav-open .sidebar{ transform:translateX(0); }
    .hamburger{ position:fixed; left:14px; top:14px; z-index:1002; width:40px; height:40px; border-radius:10px; border:2px solid var(--navy); background:#fff; display:none; align-items:center; justify-content:center; cursor:pointer; }
    .hamburger span{ width:20px; height:2px; background:var(--navy); position:relative; display:block; }
    .hamburger span::before, .hamburger span::after{ content:''; position:absolute; left:0; right:0; height:2px; background:var(--navy); }
    .hamburger span::before{ top:-6px; }
    .hamburger span::after{ top:6px; }
    .overlay{ position:fixed; inset:0; background:transparent; z-index:1000; display:none; }
    body.nav-open .overlay{ display:block; }

    /* Sidebar (já definida acima com width:220px) */
    .brand{ display:flex; flex-direction:column; align-items:center; gap:8px; margin-bottom:8px; text-align:center; }
    .brand img{ width:66px; height:auto; }
    .brand .name{ font-weight:800; letter-spacing:0.5px; color:var(--navy); font-size:18px; }
    .brand .sub{ font-size:11px; color:#6c7b86; letter-spacing:0.6px; margin-top:-6px; }
    .menu{ width:100%; display:flex; flex-direction:column; gap:16px; margin-top:8px; flex:1; }
    #btnLogout{ margin-top:auto; }
    .pill{ 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      color:#fff; 
      font-weight:700; 
      font-size:13px; 
      letter-spacing:.3px; 
      height:28px; 
      border-radius:999px; 
      background:var(--navy); 
      box-shadow:0 2px 6px rgba(0,0,0,0.08); 
      width:100%; 
      border:none; 
      cursor:pointer; 
      text-decoration:none;
      transition: background-color 0.2s;
    }
    .pill:where(:hover, :focus-visible){ 
      background:#1a7189; 
      outline: none;
    }
    .pill:focus-visible{ 
      box-shadow: 0 0 0 3px #58C6D8;
    }
    .pill[aria-current="page"]{ 
      background:#1F86A5; 
      border:2px solid #fff; 
      box-shadow:0 0 0 2px #1F86A5; 
    }

    /* Conteúdo + dashboard */
    .content{ position:relative; flex:1; height:100%; background:#fff; padding:28px; overflow:auto; margin-left:0; }
    .watermark{ position:absolute; right:-120px; top:-40px; width:1200px; opacity:0.06; pointer-events:none; user-select:none; }

    /* Título */
    .page-title{ margin:0 0 18px 0; font-size:22px; font-weight:800; color:var(--navy); letter-spacing:.3px; }

    /* KPIs */
    .kpis{ display:grid; grid-template-columns: repeat(4, minmax(140px, 1fr)); gap:16px; margin-bottom:22px; }
    .kpi{ 
      background:var(--bg); 
      border-radius:12px; 
      padding:18px 16px; 
      text-align:center; 
      box-shadow:0 2px 12px rgba(0,0,0,0.05);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid #e5e7eb;
    }
    .kpi:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .kpi-label{ 
      color:#6b7280; 
      font-size:13px; 
      margin-bottom:6px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    .kpi-value{ 
      font-size:26px; 
      font-weight:700; 
      color:var(--navy);
      margin-bottom: 4px;
    }
    .kpi-trend {
      font-size: 12px;
      font-weight: 600;
    }
    .kpi-trend.up { color: #10b981; }
    .kpi-trend.down { color: #ef4444; }

    /* Grid principal */
    .main-grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:22px; align-items:start; }
    .panel{ 
      background:var(--bg); 
      border-radius:12px; 
      box-shadow:0 2px 12px rgba(0,0,0,0.04);
      border: 1px solid #e5e7eb;
      overflow:hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .panel:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #f0f4f8;
    }
    .panel-title{ 
      margin: 0;
      font-size:15px; 
      font-weight:600; 
      color:var(--navy);
    }
    .panel-body{ 
      padding: 0;
    }
    .btn-more {
      background: none;
      border: none;
      color: #4b5563;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .btn-more:hover {
      background: #f3f4f6;
      color: #1f2937;
    }

    /* Tabela */
    .table{ width:100%; border-collapse:separate; border-spacing:0 10px; }
    .table thead th{ text-align:left; font-size:12px; color:#334; opacity:.8; padding:0 10px; }
    .table-responsive {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .table{ 
      width:100%; 
      border-collapse:separate;
      border-spacing: 0;
      min-width: 600px;
    }
    .table th{ 
      text-align:left; 
      padding: 12px 16px; 
      font-size:12px; 
      color:#6b7280; 
      font-weight:600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
    }
    .table th:first-child {
      border-top-left-radius: 8px;
    }
    .table th:last-child {
      border-top-right-radius: 8px;
    }
    .table td{ 
      padding: 16px;
      border-bottom: 1px solid #f3f4f6; 
      font-size:13.5px;
      vertical-align: middle;
    }
    .table tbody tr:last-child td {
      border-bottom: none;
    }
    .table tbody tr:hover {
      background-color: #f9fafb;
    }
    .text-mono {
      font-family: 'Roboto Mono', monospace;
      color: #4b5563;
    }
    .user-avatar {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .user-avatar > span {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: #e0f2fe;
      color: #0369a1;
      font-size: 12px;
      font-weight: 600;
    }
    .activity-time {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    /* Atividade */
    .activity{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:10px; }
    .activity li{ 
      display:flex; 
      gap:12px; 
      align-items:flex-start; 
      font-size:13px; 
      background:#f8fafc; 
      border-left:3px solid #1F86A5;
      border-radius:4px; 
      padding:10px 12px;
      transition: all 0.2s ease;
    }
    .activity li:hover {
      background: #f1f5f9;
      transform: translateX(2px);
    }
    .dot{ 
      flex-shrink: 0;
      width:8px; 
      height:8px; 
      border-radius:50%; 
      background:#1F86A5; 
      margin-top:6px; 
    }

    /* Usuarios (cadastro) */
    .form-grid{ display:grid; grid-template-columns: repeat(2, minmax(200px,1fr)); gap:14px; padding:16px; }
    .form-grid .input{ display:flex; flex-direction:column; gap:6px; }
    .form-grid label{ font-size:12px; color:#6b7280; font-weight:600; }
    .form-grid input, .form-grid select{ height:36px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px; font-family:inherit; font-size:13px; }
    .actions{ display:flex; gap:10px; padding:0 16px 16px 16px; }
    .btn{ background:#1F86A5; color:#fff; border:none; border-radius:8px; padding:8px 14px; font-weight:700; cursor:pointer; }
    .btn:hover{ background:#1a7189; }

    /* Modal */
    .modal{ position:fixed; inset:0; z-index:1100; display:flex; align-items:center; justify-content:center; padding:20px; }
    .modal[hidden]{ display:none; }
    .modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.35); }
    .modal-dialog{ position:relative; background:#fff; width:min(720px, 100%); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.2); overflow:hidden; transform:translateY(10px); opacity:0; transition:.2s ease; }
    .modal.open .modal-dialog{ transform:translateY(0); opacity:1; }
    .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #eef2f7; }
    .modal-header h3{ margin:0; font-size:16px; color:var(--navy); }
    .modal-close{ background:none; border:none; font-size:20px; line-height:1; cursor:pointer; color:#6b7280; }
    .modal-body{ padding:0; }

    /* Desktop: sidebar fixa sempre visível; sem hambúrguer nem overlay */
    @media (min-width: 1025px){
      .sidebar{ transform:none; }
      .content{ margin-left:220px; }
      .hamburger, .overlay{ display:none !important; }
    }
    /* Mobile & Tablet */
    @media (max-width: 1024px){
      .hamburger{ display:flex; }
      .kpis{ grid-template-columns: repeat(2, 1fr); }
      .main-grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <button class="hamburger" id="btnMenu" aria-label="Abrir menu"><span></span></button>
  <div class="overlay" id="overlay" hidden></div>
  <div class="wrap">
    <aside class="sidebar">
      <div class="brand">
        <img src="IMG/ICON.png" alt="ARIBRA"/>
        <div class="name">ARIBRA</div>
        <div class="sub">ASISTENCIA S.L.</div>
      </div>

      <nav class="menu" aria-label="menu">
        <button class="pill" type="button" data-section="dashboard" aria-current="page">Dashboard</button>
        <button class="pill" type="button" data-section="usuarios">Usuarios</button>
        <button class="pill" type="button" data-section="facturasgasoil">Facturas Gasoil</button>
        <button class="pill" type="button" data-section="facturasherramientas">Facturas Herramientas</button>
        <button class="pill" type="button" data-section="baterias">Preços das Baterias</button>
        <button class="pill" type="button" data-section="config">Configurações</button>
        <button class="pill" id="btnLogout" type="button" style="background:#ef4444">Sair</button>
      </nav>
    </aside>

    <main class="content">
      <section id="view-dashboard" data-title="Dashboard (Admin)">
        <h1 class="page-title">Dashboard (Admin)</h1>

      <section class="kpis">
        <div class="kpi">
          <div class="kpi-label">Total Facturas</div>
          <div class="kpi-value" id="admKpiFacTotal">0</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Gasoil</div>
          <div class="kpi-value" id="admKpiFacGas">0</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Herramientas</div>
          <div class="kpi-value" id="admKpiFacHer">0</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Modelos de Baterias</div>
          <div class="kpi-value" id="admKpiBat">0</div>
        </div>
      </section>

      

      <section class="main-grid">
        <div class="panel">
          <div class="panel-header">
            <h3 class="panel-title">Últimas Facturas</h3>
            <button class="btn-more" aria-label="Ver mais" onclick="document.querySelector('[data-section=\'facturasgasoil\']')?.click()">Ver Tudo</button>
          </div>
          <div class="panel-body">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Nome</th>
                    <th>Detalhe</th>
                    <th>Data</th>
                  </tr>
                </thead>
                <tbody id="admRecentTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h3 class="panel-title">Atividade Recente</h3>
          </div>
          <div class="panel-body">
            <ul class="activity">
              <li>
                <span class="dot"></span>
                <div>
                  <div>Usuário admin atualizou permissões</div>
                  <div class="activity-time">Há 5 minutos</div>
                </div>
              </li>
              <li>
                <span class="dot"></span>
                <div>
                  <div>Novo usuário criado: operador-02</div>
                  <div class="activity-time">Há 1 hora</div>
                </div>
              </li>
              <li>
                <span class="dot"></span>
                <div>
                  <div>Configuração salva com sucesso</div>
                  <div class="activity-time">Hoje às 14:30</div>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </section>

      <img src="IMG/LOGO.png" class="watermark" alt="Marca d'agua" />
      </section>

      <section id="view-baterias" data-title="Baterias" hidden>
        <h1 class="page-title">Baterias</h1>

        <div class="panel" style="margin-bottom:16px;">
          <div class="panel-header">
            <h3 class="panel-title">Cadastrar / Editar Bateria</h3>
          </div>
          <div class="panel-body">
            <form id="batForm">
              <div class="form-grid" style="grid-template-columns: repeat(5, minmax(160px,1fr));">
                <div class="input">
                  <label for="batModelo">Modelo</label>
                  <input id="batModelo" name="modelo" required />
                </div>
                <div class="input">
                  <label for="batAmperes">Amperes</label>
                  <input id="batAmperes" name="amperes" type="number" step="1" min="0" required />
                </div>
                <div class="input">
                  <label for="batTipo">Tipo</label>
                  <input id="batTipo" name="tipo" required />
                </div>
                <div class="input">
                  <label for="batPrecoSocio">Preço Sócio</label>
                  <input id="batPrecoSocio" name="precoSocio" type="number" step="0.01" min="0" required />
                </div>
                <div class="input">
                  <label for="batPrecoCliente">Preço Cliente</label>
                  <input id="batPrecoCliente" name="precoCliente" type="number" step="0.01" min="0" required />
                </div>
              </div>
              <div class="actions" style="justify-content:flex-end; padding-top:8px;">
                <button class="btn" type="button" id="batBtnCancelar" style="background:#6b7280">Limpar</button>
                <button class="btn" type="submit" id="batBtnSubmit">Salvar</button>
              </div>
            </form>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h3 class="panel-title">Baterias Cadastradas</h3>
          </div>
          <div class="panel-body">
            <div class="actions" style="gap:8px; padding:12px 16px;">
              <input id="batFilterModelo" placeholder="Filtrar por modelo" style="flex:1; max-width:280px; height:36px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px; font-family:inherit; font-size:13px;" />
            </div>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Modelo</th>
                    <th>Amperes</th>
                    <th>Tipo</th>
                    <th>Preço Sócio</th>
                    <th>Preço Cliente</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="batTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- View: Facturas Herramientas -->
      <section id="view-facturasherramientas" data-title="Facturas Herramientas" hidden>
        <h1 class="page-title">Facturas Herramientas</h1>

        <div class="panel">
          <div class="panel-header">
            <h3 class="panel-title">Todas as facturas de Herramientas</h3>
          </div>
          <div class="panel-body">
            <div class="actions" style="gap:8px; padding:12px 16px; flex-wrap:wrap;">
              <input id="herFilterName" placeholder="Filtrar por nome" style="flex:1; min-width:220px; height:36px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px; font-family:inherit; font-size:13px;" />
              <input id="herFilterDate" type="date" title="Filtrar por data de criação" style="height:36px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px; font-family:inherit; font-size:13px;" />
            </div>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Item</th>
                    <th>Data</th>
                    <th>Imagem</th>
                  </tr>
                </thead>
                <tbody id="herTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="view-facturasgasoil" data-title="Facturas Gasoil" hidden>
        <h1 class="page-title">Facturas Gasoil</h1>

        <div class="panel">
          <div class="panel-header">
            <h3 class="panel-title">Todas as facturas de gasoil</h3>
          </div>
          <div class="panel-body">
            <div class="actions" style="gap:8px; padding:12px 16px; flex-wrap:wrap;">
              <input id="gasFilterName" placeholder="Filtrar por nome" style="flex:1; min-width:220px; height:36px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px; font-family:inherit; font-size:13px;" />
              <input id="gasFilterDate" type="date" title="Filtrar por data de criação" style="height:36px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px; font-family:inherit; font-size:13px;" />
            </div>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Matrícula</th>
                    <th>KM</th>
                    <th>Data</th>
                    <th>Imagem</th>
                  </tr>
                </thead>
                <tbody id="gasTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="view-usuarios" data-title="Usuarios" hidden>
        <h1 class="page-title">Usuarios</h1>

        <div class="actions" style="justify-content:flex-end; padding:0 0 12px 0;">
          <button class="btn" id="btnOpenUserModal" type="button">Cadastrar Usuário</button>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h3 class="panel-title">Usuários Cadastrados</h3>
          </div>
          <div class="panel-body">
            <div class="actions" style="gap:8px; padding:12px 16px;">
              <input id="userFilterName" placeholder="Filtrar por nome" style="flex:1; max-width:280px; height:36px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px; font-family:inherit; font-size:13px;" />
            </div>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Perfil</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="usersTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Modal Cadastro Usuário -->
        <div id="userModal" class="modal" hidden>
          <div class="modal-backdrop" aria-hidden="true"></div>
          <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="userModalTitle">
            <div class="modal-header">
              <h3 id="userModalTitle">Cadastrar Usuário</h3>
              <button class="modal-close" id="btnCloseUserModal" type="button" aria-label="Fechar">×</button>
            </div>
            <div class="modal-body">
              <form id="userForm">
                <div class="form-grid">
                  <div class="input">
                    <label for="nome">Nome</label>
                    <input id="nome" name="nome" required />
                  </div>
                  <div class="input">
                    <label for="email">Email</label>
                    <input id="email" name="email" type="email" required />
                  </div>
                  <div class="input">
                    <label for="perfil">Perfil</label>
                    <select id="perfil" name="perfil">
                      <option value="operador">Operador</option>
                    </select>
                  </div>
                  <div class="input">
                    <label for="senha">Senha</label>
                    <input id="senha" name="senha" type="password" required />
                  </div>
                </div>
                <div class="actions" style="justify-content:flex-end;">
                  <button class="btn" type="button" id="btnCancelUserModal" style="background:#6b7280">Cancelar</button>
                  <button class="btn" type="submit">Salvar</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>

      <section id="view-config" data-title="Configurações" hidden>
        <h1 class="page-title">Configurações</h1>

        <div class="panel" style="margin-bottom:16px;">
          <div class="panel-header">
            <h3 class="panel-title">Alterar senha do administrador</h3>
          </div>
          <div class="panel-body">
            <form id="adminPwdForm">
              <div class="form-grid" style="grid-template-columns: repeat(3, minmax(200px,1fr));">
                <div class="input">
                  <label for="curPwd">Senha atual</label>
                  <input id="curPwd" name="curPwd" type="password" required />
                </div>
                <div class="input">
                  <label for="newPwd">Nova senha</label>
                  <input id="newPwd" name="newPwd" type="password" minlength="4" required />
                </div>
                <div class="input">
                  <label for="newPwd2">Confirmar nova senha</label>
                  <input id="newPwd2" name="newPwd2" type="password" minlength="4" required />
                </div>
              </div>
              <div class="actions" style="justify-content:flex-end; padding-top:8px;">
                <button class="btn" type="submit">Salvar nova senha</button>
              </div>
            </form>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h3 class="panel-title">Mensagens do sistema (agendar)</h3>
          </div>
          <div class="panel-body">
            <form id="msgForm">
              <div class="form-grid" style="grid-template-columns: 1fr 220px 220px;">
                <div class="input">
                  <label for="msgText">Mensagem</label>
                  <input id="msgText" name="msgText" maxlength="200" placeholder="Texto que aparecerá no dashboard" required />
                </div>
                <div class="input">
                  <label for="msgWhen">Data e hora</label>
                  <input id="msgWhen" name="msgWhen" type="datetime-local" required />
                </div>
                <div class="input">
                  <label for="msgUntil">Exibir até (opcional)</label>
                  <input id="msgUntil" name="msgUntil" type="datetime-local" />
                </div>
              </div>
              <div class="actions" style="justify-content:flex-end; padding-top:8px;">
                <button class="btn" type="submit">Agendar mensagem</button>
              </div>
            </form>

            <div class="table-responsive" style="margin-top:8px;">
              <table class="table">
                <thead>
                  <tr>
                    <th>Mensagem</th>
                    <th>Exibir de</th>
                    <th>Exibir até</th>
                    <th>Status</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="msgsTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Modal: Visualização da imagem da factura de ferramentas -->
      <div id="herImgModal" class="modal" hidden>
        <div class="modal-backdrop" aria-hidden="true"></div>
        <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="herImgTitle">
          <div class="modal-header">
            <h3 id="herImgTitle">Factura de Herramienta</h3>
            <button class="modal-close" id="btnCloseHerImgModal" type="button" aria-label="Fechar">×</button>
          </div>
          <div class="modal-body" style="padding:16px;">
            <img id="herImgPreview" alt="Factura de Herramienta" style="max-width:100%; height:auto; border-radius:8px; border:1px solid #eef2f7;" />
            <div class="actions" style="justify-content:flex-end; margin-top:12px; padding:0;">
              <a id="btnDownloadHerImg" class="btn" href="#" download>Download</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal: Visualização da imagem da factura de gasoil -->
      <div id="gasImgModal" class="modal" hidden>
        <div class="modal-backdrop" aria-hidden="true"></div>
        <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="gasImgTitle">
          <div class="modal-header">
            <h3 id="gasImgTitle">Factura de Gasoil</h3>
            <button class="modal-close" id="btnCloseGasImgModal" type="button" aria-label="Fechar">×</button>
          </div>
          <div class="modal-body" style="padding:16px;">
            <img id="gasImgPreview" alt="Factura de Gasoil" style="max-width:100%; height:auto; border-radius:8px; border:1px solid #eef2f7;" />
            <div class="actions" style="justify-content:flex-end; margin-top:12px; padding:0;">
              <a id="btnDownloadGasImg" class="btn" href="#" download>Download</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Edição de Bateria (Global) -->
      <div id="batEditModal" class="modal" hidden>
        <div class="modal-backdrop" aria-hidden="true" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000;"></div>
        <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="batEditModalTitle" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; max-width:720px; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.2); z-index:10001;">
          <div class="modal-header">
            <h3 id="batEditModalTitle">Editar Bateria</h3>
            <button class="modal-close" id="btnCloseBatEditModal" type="button" aria-label="Fechar">×</button>
          </div>
          <div class="modal-body">
            <form id="batEditForm">
              <div class="form-grid" style="grid-template-columns: repeat(2, minmax(160px,1fr));">
                <div class="input">
                  <label for="batEditModelo">Modelo</label>
                  <input id="batEditModelo" name="modelo" required />
                </div>
                <div class="input">
                  <label for="batEditAmperes">Amperes</label>
                  <input id="batEditAmperes" name="amperes" type="number" step="1" min="0" required />
                </div>
                <div class="input">
                  <label for="batEditTipo">Tipo</label>
                  <input id="batEditTipo" name="tipo" required />
                </div>
                <div class="input">
                  <label for="batEditPrecoSocio">Preço Sócio</label>
                  <input id="batEditPrecoSocio" name="precoSocio" type="number" step="0.01" min="0" required />
                </div>
                <div class="input">
                  <label for="batEditPrecoCliente">Preço Cliente</label>
                  <input id="batEditPrecoCliente" name="precoCliente" type="number" step="0.01" min="0" required />
                </div>
              </div>
              <div class="actions" style="justify-content:flex-end; padding-top:8px;">
                <button class="btn" type="button" id="btnCancelBatEditModal" style="background:#6b7280">Cancelar</button>
                <button class="btn" type="submit" id="batEditBtnSubmit">Atualizar</button>
              </div>
            </form>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    (function(){
      // Guarda de sessão simples: exige login válido
      try{
        if (sessionStorage.getItem('aribra_auth') !== '1') {
          window.location.href = 'index.html';
          return;
        }
      }catch(_){ /* sessionStorage indisponível */ }
      const body = document.body;
      const btn = document.getElementById('btnMenu');
      const overlay = document.getElementById('overlay');
      function close(){ body.classList.remove('nav-open'); overlay.hidden=true; }
      function open(){ body.classList.add('nav-open'); overlay.hidden=false; }
      btn.addEventListener('click', ()=>{ body.classList.contains('nav-open') ? close() : open(); });
      overlay.addEventListener('click', close);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });

      // Logout
      const btnLogout = document.getElementById('btnLogout');
      if(btnLogout){
        btnLogout.addEventListener('click', ()=>{
          try{ sessionStorage.removeItem('aribra_auth'); }catch(_){}
          window.location.href = 'index.html';
        });
      }

      // Toast centralizado (topo)
      function showToast(msg, opts={}){
        const duration = opts.duration ?? 2200;
        let el = document.getElementById('app_toast');
        if(!el){
          el = document.createElement('div');
          el.id = 'app_toast';
          el.setAttribute('role','status');
          el.style.cssText = [
            'position:fixed',
            'left:50%','top:50%','transform:translate(-50%,-50%)',
            'background:#17384A','color:#fff',
            'padding:12px 16px','border-radius:12px',
            'box-shadow:0 12px 28px rgba(0,0,0,.18)',
            'z-index:2000','opacity:0','transition:opacity .18s ease',
            'font-weight:700','letter-spacing:.2px','font-size:13px',
            'text-align:center','max-width:90vw','white-space:pre-wrap'
          ].join(';');
          document.body.appendChild(el);
        }
        el.textContent = msg;
        el.style.opacity = '1';
        clearTimeout(el._t);
        el._t = setTimeout(()=>{ el.style.opacity='0'; }, duration);
      }

      // Toggle seções (SPA simples)
      const sections = {
        dashboard: document.getElementById('view-dashboard'),
        usuarios: document.getElementById('view-usuarios'),
        baterias: document.getElementById('view-baterias'),
        facturasgasoil: document.getElementById('view-facturasgasoil'),
        facturasherramientas: document.getElementById('view-facturasherramientas'),
        config: document.getElementById('view-config')
      };
      const pills = document.querySelectorAll('.menu .pill');
      // Modal elementos e funções
      const userModal = document.getElementById('userModal');
      const btnOpenUserModal = document.getElementById('btnOpenUserModal');
      const btnCloseUserModal = document.getElementById('btnCloseUserModal');
      const btnCancelUserModal = document.getElementById('btnCancelUserModal');
      const modalBackdrop = userModal ? userModal.querySelector('.modal-backdrop') : null;

      function openUserModal(){
        if(!userModal) return;
        userModal.hidden = false;
        // animação
        requestAnimationFrame(()=> userModal.classList.add('open'));
      }
      function closeUserModal(){
        if(!userModal) return;
        userModal.classList.remove('open');
        setTimeout(()=>{ userModal.hidden = true; }, 150);
      }
      if(btnOpenUserModal) btnOpenUserModal.addEventListener('click', ()=>{ setCreateMode(); openUserModal(); });
      if(btnCloseUserModal) btnCloseUserModal.addEventListener('click', closeUserModal);
      if(btnCancelUserModal) btnCancelUserModal.addEventListener('click', closeUserModal);
      if(modalBackdrop) modalBackdrop.addEventListener('click', closeUserModal);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeUserModal(); });
      function setActive(section){
        // ao sair de Usuarios/Baterias, reseta estados
        if(section !== 'usuarios'){ closeUserModal(); setCreateMode(); }
        if(section !== 'baterias'){ batSetCreateMode(); }
        Object.entries(sections).forEach(([key, el])=>{
          if(!el) return;
          el.hidden = key !== section;
        });
        pills.forEach(b=>{
          if(b.dataset.section){
            if(b.dataset.section===section){ b.setAttribute('aria-current','page'); }
            else{ b.removeAttribute('aria-current'); }
          }
        });
        const active = sections[section];
        if(active){
          const h1 = active.querySelector('.page-title');
          if(h1){ document.title = h1.textContent + ' - ARIBRA'; }
        }
      }
      document.querySelector('.menu').addEventListener('click', (e)=>{
        const btn = e.target.closest('.pill');
        if(!btn || !btn.dataset.section) return;
        const sec = btn.dataset.section;
        if(sections[sec]){
          setActive(sec);
        }
      });

      // =====================
      // Dashboard (Admin) - KPIs + Últimas Facturas
      // =====================
      const admKpiFacTotal = document.getElementById('admKpiFacTotal');
      const admKpiFacGas = document.getElementById('admKpiFacGas');
      const admKpiFacHer = document.getElementById('admKpiFacHer');
      const admKpiBat = document.getElementById('admKpiBat');
      const admRecentTbody = document.getElementById('admRecentTbody');

      function readGas(){ try{ return JSON.parse(localStorage.getItem('aribra_facturas_gasoil')||'[]'); }catch{ return []; } }
      function readHer(){ try{ return JSON.parse(localStorage.getItem('aribra_facturas_herramientas')||'[]'); }catch{ return []; } }
      function readBat(){ try{ return JSON.parse(localStorage.getItem('aribra_baterias')||'[]'); }catch{ return []; } }

      function renderAdminKpis(){
        const gas = readGas();
        const her = readHer();
        const bat = readBat();
        if(admKpiFacGas) admKpiFacGas.textContent = String(gas.length);
        if(admKpiFacHer) admKpiFacHer.textContent = String(her.length);
        if(admKpiFacTotal) admKpiFacTotal.textContent = String(gas.length + her.length);
        if(admKpiBat) admKpiBat.textContent = String(Array.isArray(bat)? bat.length : 0);
      }

      function renderAdminRecent(){
        if(!admRecentTbody) return;
        const gas = readGas().map(x=>({ tipo:'Gasoil', nome:x.nome||'', detalhe:x.matricula||'', createdAt:x.createdAt }));
        const her = readHer().map(x=>({ tipo:'Herramientas', nome:x.nome||'', detalhe:x.item||'', createdAt:x.createdAt }));
        const all = gas.concat(her).filter(x=> x.createdAt && !Number.isNaN(Date.parse(x.createdAt)));
        all.sort((a,b)=> Date.parse(b.createdAt) - Date.parse(a.createdAt));
        const top = all.slice(0,5);
        admRecentTbody.innerHTML = top.map(r=>{
          const dateStr = new Date(r.createdAt).toLocaleString();
          return `<tr>
            <td>${r.tipo}</td>
            <td>${r.nome}</td>
            <td>${r.detalhe}</td>
            <td>${dateStr}</td>
          </tr>`;
        }).join('');
      }

      renderAdminKpis();
      renderAdminRecent();
      window.addEventListener('storage', (e)=>{
        if(e.key==='aribra_facturas_gasoil' || e.key==='aribra_facturas_herramientas' || e.key==='aribra_baterias'){
          renderAdminKpis();
          renderAdminRecent();
        }
      });

      // Usuarios: armazenamento simples em localStorage
      const LS_KEY = 'aribra_users';
      const readUsers = ()=>{
        try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; }
      };
      const writeUsers = (arr)=> localStorage.setItem(LS_KEY, JSON.stringify(arr));
      const tbody = document.getElementById('usersTbody');
      const userFilterName = document.getElementById('userFilterName');
      function renderUsers(){
        const arr = readUsers();
        const q = (userFilterName && userFilterName.value || '').toLowerCase().trim();
        const filtered = q ? arr.filter(u => (u.nome||'').toLowerCase().includes(q)) : arr;
        tbody.innerHTML = filtered.map((u, i)=>`
          <tr>
            <td>${u.nome}</td>
            <td>${u.email}</td>
            <td><span class="badge ${u.perfil==='admin'?'success':'pending'}">${u.perfil}</span></td>
            <td style="display:flex; gap:8px;">
              <button class="btn" data-act="edit" data-idx="${i}" style="background:#0ea5e9">Editar</button>
              <button class="btn" data-act="del" data-idx="${i}" style="background:#ef4444">Remover</button>
            </td>
          </tr>
        `).join('');
      }
      const form = document.getElementById('userForm');
      let editIndex = null; // null = criando, número = editando
      const formSubmitBtn = form ? form.querySelector('button[type="submit"]') : null;

      function setCreateMode(){
        editIndex = null;
        if(form){ form.reset(); }
        const title = document.getElementById('userModalTitle');
        if(title) title.textContent = 'Cadastrar Usuário';
        if(formSubmitBtn) formSubmitBtn.textContent = 'Salvar';
      }

      function setEditMode(idx){
        const arr = readUsers();
        const u = arr[idx];
        if(!u) return;
        editIndex = idx;
        const title = document.getElementById('userModalTitle');
        if(title) title.textContent = 'Editar Usuário';
        if(formSubmitBtn) formSubmitBtn.textContent = 'Atualizar';
        // preencher campos
        const nome = document.getElementById('nome');
        const email = document.getElementById('email');
        const perfil = document.getElementById('perfil');
        const senha = document.getElementById('senha');
        if(nome) nome.value = u.nome || '';
        if(email) email.value = u.email || '';
        if(perfil) perfil.value = 'operador';
        if(senha) senha.value = '';
      }
      if(form){
        form.addEventListener('submit', (ev)=>{
          ev.preventDefault();
          const data = Object.fromEntries(new FormData(form).entries());
          const arr = readUsers();
          if(editIndex===null){
            arr.push({ nome:data.nome, email:data.email, perfil:'operador' });
          } else {
            arr[editIndex] = { nome:data.nome, email:data.email, perfil:'operador' };
          }
          writeUsers(arr);
          form.reset();
          if(userFilterName){ userFilterName.addEventListener('input', renderUsers); }
      renderUsers();
          closeUserModal();
          showToast(editIndex===null ? 'Usuário salvo.' : 'Usuário atualizado.');
          setCreateMode();
        });
      }
      if(tbody){
        tbody.addEventListener('click', (e)=>{
          const btnDel = e.target.closest('button[data-act="del"]');
          const btnEdit = e.target.closest('button[data-act="edit"]');
          if(btnDel){
            const idx = +btnDel.dataset.idx;
            const arr = readUsers();
            arr.splice(idx,1);
            writeUsers(arr);
            renderUsers();
            return;
          }
          if(btnEdit){
            const idx = +btnEdit.dataset.idx;
            setEditMode(idx);
            openUserModal();
            return;
          }
        });
      }
      renderUsers();

      // =====================
      // Baterias (CRUD simples em localStorage)
      // =====================
      const BAT_KEY = 'aribra_baterias';
      const readBats = ()=>{ try{ return JSON.parse(localStorage.getItem(BAT_KEY)||'[]'); }catch{ return []; } };
      const writeBats = (arr)=> localStorage.setItem(BAT_KEY, JSON.stringify(arr));

      const batForm = document.getElementById('batForm');
      const batBtnSubmit = document.getElementById('batBtnSubmit');
      const batBtnCancelar = document.getElementById('batBtnCancelar');
      const batTbody = document.getElementById('batTbody');
      const batFilterModelo = document.getElementById('batFilterModelo');
      let batEditIndex = null;

      function fmtMoney(v){
        const n = Number(v);
        if(Number.isNaN(n)) return '-';
        try{ return n.toLocaleString(undefined, { style:'currency', currency:'EUR' }); }catch{ return n.toFixed(2); }
      }

      function batRender(){
        if(!batTbody) return;
        const arr = readBats();
        const q = (batFilterModelo && batFilterModelo.value || '').toLowerCase().trim();
        const filtered = q ? arr.filter(b => (b.modelo||'').toLowerCase().includes(q)) : arr;
        batTbody.innerHTML = filtered.map((b,i)=>`
          <tr>
            <td>${b.modelo||''}</td>
            <td>${b.amperes||''}</td>
            <td>${b.tipo||''}</td>
            <td>${fmtMoney(b.precoSocio)}</td>
            <td>${fmtMoney(b.precoCliente)}</td>
            <td style="display:flex; gap:8px;">
              <button class="btn" data-act="edit" data-idx="${i}" style="background:#0ea5e9">Editar</button>
              <button class="btn" data-act="del" data-idx="${i}" style="background:#ef4444">Remover</button>
            </td>
          </tr>
        `).join('');
      }

      function batSetCreateMode(){
        batEditIndex = null;
        if(batForm) batForm.reset();
        if(batBtnSubmit) batBtnSubmit.textContent = 'Salvar';
      }

      function batSetEditMode(idx){
        const arr = readBats();
        const b = arr[idx];
        if(!b) return;
        batEditIndex = idx;
        if(batBtnSubmit) batBtnSubmit.textContent = 'Atualizar';
        const m = document.getElementById('batModelo');
        const a = document.getElementById('batAmperes');
        const t = document.getElementById('batTipo');
        const ps = document.getElementById('batPrecoSocio');
        const pc = document.getElementById('batPrecoCliente');
        if(m) m.value = b.modelo||'';
        if(a) a.value = b.amperes||'';
        if(t) t.value = b.tipo||'';
        if(ps) ps.value = b.precoSocio||'';
        if(pc) pc.value = b.precoCliente||'';
      }

      if(batForm){
        batForm.addEventListener('submit', (ev)=>{
          ev.preventDefault();
          const fd = new FormData(batForm);
          const data = Object.fromEntries(fd.entries());
          // normaliza números
          const b = {
            modelo: String(data.modelo||'').trim(),
            amperes: Number(data.amperes||0),
            tipo: String(data.tipo||'').trim(),
            precoSocio: Number(data.precoSocio||0),
            precoCliente: Number(data.precoCliente||0)
          };
          if(!b.modelo){ showToast('Informe o modelo.'); return; }
          if(!b.tipo){ showToast('Informe o tipo.'); return; }
          const arr = readBats();
          if(batEditIndex===null){ arr.push(b); }
          else { arr[batEditIndex] = b; }
          writeBats(arr);
          if(batFilterModelo){ batFilterModelo.addEventListener('input', batRender); }
      batRender();
          batSetCreateMode();
          showToast(batEditIndex===null ? 'Bateria adicionada.' : 'Bateria atualizada.');
        });
      }
      if(batBtnCancelar){ batBtnCancelar.addEventListener('click', batSetCreateMode); }
      // Modal de edição de bateria
      const batEditModal = document.getElementById('batEditModal');
      const btnCloseBatEditModal = document.getElementById('btnCloseBatEditModal');
      const btnCancelBatEditModal = document.getElementById('btnCancelBatEditModal');
      const batEditForm = document.getElementById('batEditForm');
      const batEditBackdrop = batEditModal ? batEditModal.querySelector('.modal-backdrop') : null;
      const batEditModelo = document.getElementById('batEditModelo');
      const batEditAmperes = document.getElementById('batEditAmperes');
      const batEditTipo = document.getElementById('batEditTipo');
      const batEditPrecoSocio = document.getElementById('batEditPrecoSocio');
      const batEditPrecoCliente = document.getElementById('batEditPrecoCliente');
      let batEditIdx = null;

      function openBatEditModal(idx){
        const arr = readBats();
        const b = arr[idx];
        if(!b || !batEditModal){ showToast && showToast('Erro ao abrir modal.'); return; }
        batEditIdx = idx;
        if(batEditModelo) batEditModelo.value = b.modelo || '';
        if(batEditAmperes) batEditAmperes.value = b.amperes || '';
        if(batEditTipo) batEditTipo.value = b.tipo || '';
        if(batEditPrecoSocio) batEditPrecoSocio.value = b.precoSocio ?? '';
        if(batEditPrecoCliente) batEditPrecoCliente.value = b.precoCliente ?? '';
        batEditModal.hidden = false;
        // força visibilidade caso estilos dependam de classe
        batEditModal.style.display = 'block';
        batEditModal.classList.add('open');
        // foca primeiro campo para evidenciar abertura
        setTimeout(()=>{ if(batEditModelo) batEditModelo.focus(); }, 0);
      }
      function closeBatEditModal(){
        if(!batEditModal) return;
        batEditModal.classList.remove('open');
        setTimeout(()=>{ batEditModal.hidden = true; batEditModal.style.display=''; batEditIdx = null; }, 150);
      }
      if(btnCloseBatEditModal) btnCloseBatEditModal.addEventListener('click', closeBatEditModal);
      if(btnCancelBatEditModal) btnCancelBatEditModal.addEventListener('click', closeBatEditModal);
      if(batEditBackdrop) batEditBackdrop.addEventListener('click', closeBatEditModal);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeBatEditModal(); });

      if(batEditForm){
        batEditForm.addEventListener('submit', (ev)=>{
          ev.preventDefault();
          if(batEditIdx===null){ closeBatEditModal(); return; }
          const fd = new FormData(batEditForm);
          const data = Object.fromEntries(fd.entries());
          const arr = readBats();
          const base = arr[batEditIdx];
          if(!base){ closeBatEditModal(); return; }
          const updated = {
            modelo: String(data.modelo||'').trim(),
            amperes: Number(data.amperes||0),
            tipo: String(data.tipo||'').trim(),
            precoSocio: Number(data.precoSocio||0),
            precoCliente: Number(data.precoCliente||0)
          };
          if(!updated.modelo){ showToast('Informe o modelo.'); return; }
          if(!updated.tipo){ showToast('Informe o tipo.'); return; }
          arr[batEditIdx] = updated;
          writeBats(arr);
          batRender();
          closeBatEditModal();
          showToast('Bateria atualizada.');
        });
      }

      if(batTbody){
        batTbody.addEventListener('click', (e)=>{
          const del = e.target.closest('button[data-act="del"]');
          const edit = e.target.closest('button[data-act="edit"]');
          if(del){
            const idx = +del.dataset.idx;
            const arr = readBats();
            arr.splice(idx,1);
            writeBats(arr);
            batRender();
            return;
          }
          if(edit){
            const idx = +edit.dataset.idx;
            openBatEditModal(idx);
            return;
          }
        });
      }
      batRender();

      // =====================
      // Facturas Gasoil (visualização)
      // =====================
      const GAS_KEY = 'aribra_facturas_gasoil';
      const gasTbody = document.getElementById('gasTbody');
      const gasFilterName = document.getElementById('gasFilterName');
      const gasFilterDate = document.getElementById('gasFilterDate');
      function gasRead(){ try{ return JSON.parse(localStorage.getItem(GAS_KEY)||'[]'); }catch{ return []; } }
      function renderGas(){
        if(!gasTbody) return;
        const arr = gasRead();
        const q = (gasFilterName && gasFilterName.value || '').toLowerCase().trim();
        const d = (gasFilterDate && gasFilterDate.value || '').trim(); // 'YYYY-MM-DD'
        const filtered = arr.filter(g => {
          const okName = q ? (String(g.nome||'').toLowerCase().includes(q)) : true;
          if(!okName) return false;
          if(!d) return true;
          if(!g.createdAt) return false;
          const day = new Date(g.createdAt);
          if(Number.isNaN(day.getTime())) return false;
          const isoDay = `${day.getFullYear()}-${String(day.getMonth()+1).padStart(2,'0')}-${String(day.getDate()).padStart(2,'0')}`;
          return isoDay === d;
        });
        gasTbody.innerHTML = filtered.map((g, i)=>{
          const km = (g.km===null || typeof g.km==='undefined' || isNaN(Number(g.km))) ? '-' : Number(g.km);
          const dt = g.createdAt ? (new Date(g.createdAt)).toLocaleString() : '-';
          const img = g.imagem ? `<img src="${g.imagem}" alt="Factura" data-img="${g.imagem}" data-name="${(g.nome||'').replace(/"/g,'&quot;')}" data-mat="${(g.matricula||'').replace(/"/g,'&quot;')}" data-created="${g.createdAt||''}" style="max-width:120px; height:auto; border:1px solid #e5e7eb; border-radius:6px; cursor: zoom-in;" />` : '-';
          return `
            <tr>
              <td>${g.nome||''}</td>
              <td>${g.matricula||''}</td>
              <td>${km}</td>
              <td>${dt}</td>
              <td>${img}</td>
            </tr>
          `;
        }).join('');
      }
      if(gasFilterName){ gasFilterName.addEventListener('input', renderGas); }
      if(gasFilterDate){ gasFilterDate.addEventListener('change', renderGas); }
      renderGas();
      window.addEventListener('storage', (e)=>{ if(e.key===GAS_KEY) renderGas(); });
      setInterval(renderGas, 15000);

      // =====================
      // Facturas Herramientas (visualização)
      // =====================
      const HER_KEY = 'aribra_facturas_herramientas';
      const herTbody = document.getElementById('herTbody');
      const herFilterName = document.getElementById('herFilterName');
      const herFilterDate = document.getElementById('herFilterDate');
      function herRead(){ try{ return JSON.parse(localStorage.getItem(HER_KEY)||'[]'); }catch{ return []; } }
      function renderHer(){
        if(!herTbody) return;
        const arr = herRead();
        const q = (herFilterName && herFilterName.value || '').toLowerCase().trim();
        const d = (herFilterDate && herFilterDate.value || '').trim();
        const filtered = arr.filter(h => {
          const okName = q ? (String(h.nome||'').toLowerCase().includes(q)) : true;
          if(!okName) return false;
          if(!d) return true;
          if(!h.createdAt) return false;
          const day = new Date(h.createdAt);
          if(Number.isNaN(day.getTime())) return false;
          const isoDay = `${day.getFullYear()}-${String(day.getMonth()+1).padStart(2,'0')}-${String(day.getDate()).padStart(2,'0')}`;
          return isoDay === d;
        });
        herTbody.innerHTML = filtered.map((h)=>{
          const dt = h.createdAt ? (new Date(h.createdAt)).toLocaleString() : '-';
          const img = h.imagem ? `<img src="${h.imagem}" alt="Factura" data-img="${h.imagem}" data-item="${(h.item||'').replace(/"/g,'&quot;')}" data-created="${h.createdAt||''}" style="max-width:120px; height:auto; border:1px solid #e5e7eb; border-radius:6px; cursor: zoom-in;" />` : '-';
          return `
            <tr>
              <td>${h.nome||''}</td>
              <td>${h.item||''}</td>
              <td>${dt}</td>
              <td>${img}</td>
            </tr>
          `;
        }).join('');
      }
      if(herFilterName){ herFilterName.addEventListener('input', renderHer); }
      if(herFilterDate){ herFilterDate.addEventListener('change', renderHer); }
      renderHer();
      window.addEventListener('storage', (e)=>{ if(e.key===HER_KEY) renderHer(); });
      setInterval(renderHer, 15000);

      // Modal de visualização da imagem da factura (herramientas)
      const herImgModal = document.getElementById('herImgModal');
      const btnCloseHerImgModal = document.getElementById('btnCloseHerImgModal');
      const herImgPreview = document.getElementById('herImgPreview');
      const btnDownloadHerImg = document.getElementById('btnDownloadHerImg');
      const herImgBackdrop = herImgModal ? herImgModal.querySelector('.modal-backdrop') : null;

      function buildHerFileName(item, created){
        let d = '';
        try{ if(created){ const x = new Date(created); d = `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`; } }catch(_){/* ignore */}
        const it = (item||'item').toString().replace(/[^a-zA-Z0-9_-]+/g,'-');
        return `factura-herramienta-${it}${d?'-'+d:''}.png`;
      }

      function openHerImgModal(url, filename){
        if(!herImgModal) return;
        if(herImgPreview) herImgPreview.src = url;
        if(btnDownloadHerImg){
          btnDownloadHerImg.href = url;
          btnDownloadHerImg.setAttribute('download', filename || 'factura-herramienta.png');
        }
        herImgModal.hidden = false;
        requestAnimationFrame(()=> herImgModal.classList.add('open'));
      }
      function closeHerImgModal(){
        if(!herImgModal) return;
        herImgModal.classList.remove('open');
        setTimeout(()=>{ herImgModal.hidden = true; if(herImgPreview) herImgPreview.src=''; }, 150);
      }
      if(herTbody){
        herTbody.addEventListener('click', (e)=>{
          const imgEl = e.target.closest('img[data-img]');
          if(!imgEl) return;
          const url = imgEl.getAttribute('data-img');
          const item = imgEl.getAttribute('data-item') || '';
          const created = imgEl.getAttribute('data-created') || '';
          const filename = buildHerFileName(item, created);
          openHerImgModal(url, filename);
        });
      }
      if(btnCloseHerImgModal) btnCloseHerImgModal.addEventListener('click', closeHerImgModal);
      if(herImgBackdrop) herImgBackdrop.addEventListener('click', closeHerImgModal);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeHerImgModal(); });

      // Modal de visualização da imagem da factura
      const gasImgModal = document.getElementById('gasImgModal');
      const btnCloseGasImgModal = document.getElementById('btnCloseGasImgModal');
      const gasImgPreview = document.getElementById('gasImgPreview');
      const btnDownloadGasImg = document.getElementById('btnDownloadGasImg');
      const gasImgBackdrop = gasImgModal ? gasImgModal.querySelector('.modal-backdrop') : null;

      function buildFileName(mat, created){
        let d = '';
        try{ if(created){ const x = new Date(created); d = `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`; } }catch(_){/* ignore */}
        const m = (mat||'sem-placa').toString().replace(/[^a-zA-Z0-9_-]+/g,'-');
        return `factura-gasoil-${m}${d?'-'+d:''}.png`;
      }

      function openGasImgModal(url, filename){
        if(!gasImgModal) return;
        if(gasImgPreview) gasImgPreview.src = url;
        if(btnDownloadGasImg){
          btnDownloadGasImg.href = url;
          btnDownloadGasImg.setAttribute('download', filename || 'factura-gasoil.png');
        }
        gasImgModal.hidden = false;
        requestAnimationFrame(()=> gasImgModal.classList.add('open'));
      }
      function closeGasImgModal(){
        if(!gasImgModal) return;
        gasImgModal.classList.remove('open');
        setTimeout(()=>{ gasImgModal.hidden = true; if(gasImgPreview) gasImgPreview.src=''; }, 150);
      }

      if(gasTbody){
        gasTbody.addEventListener('click', (e)=>{
          const imgEl = e.target.closest('img[data-img]');
          if(!imgEl) return;
          const url = imgEl.getAttribute('data-img');
          const mat = imgEl.getAttribute('data-mat') || '';
          const created = imgEl.getAttribute('data-created') || '';
          const filename = buildFileName(mat, created);
          openGasImgModal(url, filename);
        });
      }
      if(btnCloseGasImgModal) btnCloseGasImgModal.addEventListener('click', closeGasImgModal);
      if(gasImgBackdrop) gasImgBackdrop.addEventListener('click', closeGasImgModal);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeGasImgModal(); });

      // =====================
      // Configurações (senha admin + mensagens agendadas)
      // =====================
      const ADMIN_PWD_KEY = 'aribra_admin_pwd';
      const MSGS_KEY = 'aribra_scheduled_msgs';

      // Garante uma senha inicial caso não exista (apenas local, demo)
      try{
        if(!localStorage.getItem(ADMIN_PWD_KEY)){
          localStorage.setItem(ADMIN_PWD_KEY, 'admin');
        }
      }catch(_){/* ignore */}

      // Alterar senha admin
      const adminPwdForm = document.getElementById('adminPwdForm');
      if(adminPwdForm){
        adminPwdForm.addEventListener('submit', (ev)=>{
          ev.preventDefault();
          const fd = new FormData(adminPwdForm);
          const cur = String(fd.get('curPwd')||'');
          const np = String(fd.get('newPwd')||'');
          const np2 = String(fd.get('newPwd2')||'');
          const saved = localStorage.getItem(ADMIN_PWD_KEY)||'';
          if(cur !== saved){ showToast('Senha atual incorreta.'); return; }
          if(np.length < 4){ showToast('A nova senha deve ter pelo menos 4 caracteres.'); return; }
          if(np !== np2){ showToast('A confirmação não confere.'); return; }
          localStorage.setItem(ADMIN_PWD_KEY, np);
          adminPwdForm.reset();
          showToast('Senha atualizada com sucesso.');
        });
      }

      // Utilidades de mensagens
      const readMsgs = ()=>{ try{ return JSON.parse(localStorage.getItem(MSGS_KEY)||'[]'); }catch{ return []; } };
      const writeMsgs = (arr)=> localStorage.setItem(MSGS_KEY, JSON.stringify(arr));

      const msgsTbody = document.getElementById('msgsTbody');
      function renderMsgs(){
        if(!msgsTbody) return;
        const arr = readMsgs();
        const now = Date.now();
        msgsTbody.innerHTML = arr.map((m, i)=>{
          const startTs = new Date(m.when).getTime();
          const untilTs = m.until ? new Date(m.until).getTime() : NaN;
          const startStr = isNaN(startTs) ? '-' : new Date(startTs).toLocaleString();
          const untilStr = isNaN(untilTs) ? '-' : new Date(untilTs).toLocaleString();
          let badge = '<span class="badge warning">Agendada</span>';
          if(!isNaN(startTs) && now >= startTs){
            if(!isNaN(untilTs)){
              badge = now <= untilTs ? '<span class="badge success">Ativa</span>' : '<span class="badge">Encerrada</span>';
            } else {
              badge = '<span class="badge success">Ativa</span>';
            }
          }
          return `
            <tr>
              <td>${m.text}</td>
              <td>${startStr}</td>
              <td>${untilStr}</td>
              <td>${badge}</td>
              <td><button class="btn" data-act="delmsg" data-idx="${i}" style="background:#ef4444">Remover</button></td>
            </tr>
          `;
        }).join('');
      }

      if(msgsTbody){
        msgsTbody.addEventListener('click', (e)=>{
          const btn = e.target.closest('button[data-act="delmsg"]');
          if(!btn) return;
          const idx = +btn.dataset.idx;
          const arr = readMsgs();
          arr.splice(idx,1);
          writeMsgs(arr);
          renderMsgs();
        });
      }

      const msgForm = document.getElementById('msgForm');
      if(msgForm){
        msgForm.addEventListener('submit', (ev)=>{
          ev.preventDefault();
          const fd = new FormData(msgForm);
          const text = String(fd.get('msgText')||'').trim();
          const when = String(fd.get('msgWhen')||'');
          const until = String(fd.get('msgUntil')||'');
          if(!text){ showToast('Informe a mensagem.'); return; }
          if(!when){ showToast('Informe data e hora inicial.'); return; }
          const ts = Date.parse(when);
          if(isNaN(ts)){ showToast('Data/hora inicial inválida.'); return; }
          let untilIso = '';
          if(until){
            const uts = Date.parse(until);
            if(isNaN(uts)){ showToast('Data/hora "Exibir até" inválida.'); return; }
            if(uts < ts){ showToast('"Exibir até" deve ser após a data inicial.'); return; }
            untilIso = new Date(uts).toISOString();
          }
          const arr = readMsgs();
          arr.push({ text, when: new Date(ts).toISOString(), until: untilIso || undefined, createdAt: new Date().toISOString() });
          writeMsgs(arr);
          msgForm.reset();
          renderMsgs();
          showToast('Mensagem agendada. Ela aparecerá no dashboard no intervalo definido.');
        });
      }

      renderMsgs();

    })();
  </script>
</body>
</html>
